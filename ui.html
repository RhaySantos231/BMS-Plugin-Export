<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Exportador Android Figma</title>
  <link rel="icon" href="image/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body class="bg-gray-50 p-6 text-gray-800 font-sans">
  <h1 class="text-2xl font-bold mb-4">Exportar layout para Android</h1>

  <button id="export" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow">
    Exportar
  </button>

  <div id="alert" class="mt-4 text-green-600 font-semibold"></div>

  <div id="progress-container" class="hidden mt-4">
    <div class="text-sm mb-1">Exportando: <span id="progress-value">0%</span></div>
    <div class="w-full bg-gray-300 rounded h-3 overflow-hidden">
      <div id="progress-bar" class="h-3 bg-green-500 w-0"></div>
    </div>
  </div>

  <section id="preview-container" class="mt-6">
    <h2 class="text-lg font-semibold mb-2">Pré-visualização</h2>
    <img id="preview-image" class="border rounded max-w-full shadow" alt="Prévia do frame" />
  </section>

  <section id="xml-container" class="mt-6 max-h-60 overflow-auto bg-white rounded p-4 border shadow">
    <h2 class="text-lg font-semibold mb-2">Arquivos XML Gerados</h2>
    <div id="xml-list" class="space-y-4"></div>
  </section>

  <section id="download-container" class="mt-6 hidden">
    <a id="download-link" 
       class="inline-block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow" 
       href="#" download="android-export.zip">
      Baixar ZIP com todos arquivos
    </a>
  </section>

  <script>
    document.getElementById("export").onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'export-android' } }, '*');
      document.getElementById("alert").textContent = "Exportando...";
      document.getElementById("progress-container").classList.remove('hidden');
      document.getElementById("download-container").classList.add('hidden');
      document.getElementById("progress-bar").style.width = "0%";
      document.getElementById("progress-value").textContent = "0%";
      document.getElementById("xml-list").innerHTML = "";
      document.getElementById("preview-image").src = "";
    };

    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'progress') {
        document.getElementById('progress-bar').style.width = msg.percent + '%';
        document.getElementById('progress-value').textContent = msg.percent + '%';
      }

      if (msg.type === 'zip-package') {
        document.getElementById("alert").textContent = "Exportação concluída.";
        document.getElementById("progress-container").classList.add('hidden');

        const xmls = msg.xmls; // Objeto com vários XMLs: { "nome.xml": "conteudo", ... }
        const xmlList = document.getElementById("xml-list");

        // Mostrar preview da primeira tela
        if (msg.preview) {
          document.getElementById("preview-image").src = "data:image/png;base64," + msg.preview;
        }

        // Limpa lista antes
        xmlList.innerHTML = '';

        // Para cada XML, cria pre + botão de download individual
        for (const [fileName, content] of Object.entries(xmls)) {
          const container = document.createElement('div');
          container.classList.add('border', 'rounded', 'p-2', 'bg-gray-100', 'shadow');

          const title = document.createElement('h3');
          title.textContent = fileName;
          title.classList.add('font-semibold', 'mb-1');
          container.appendChild(title);

          const pre = document.createElement('pre');
          pre.textContent = content;
          pre.classList.add('text-xs', 'font-mono', 'whitespace-pre-wrap', 'max-h-48', 'overflow-auto', 'mb-2');
          container.appendChild(pre);

          const btn = document.createElement('button');
          btn.textContent = 'Baixar XML';
          btn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow';
          btn.onclick = () => {
            const blob = new Blob([content], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
          };
          container.appendChild(btn);

          xmlList.appendChild(container);
        }

        // Montar ZIP com todos XMLs + imagens
        const zip = new JSZip();
        const xmlFolder = zip.folder("xml");
        for (const [fileName, content] of Object.entries(xmls)) {
          xmlFolder.file(fileName, content);
        }

        const drawable = zip.folder("drawable");
        for (const [name, base64] of Object.entries(msg.imagens)) {
          const cleanName = name.toLowerCase();
          const data = base64.split(',')[1]; // remove prefixo base64
          drawable.file(`${cleanName}.png`, data, { base64: true });
        }

        const blob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(blob);

        const link = document.getElementById("download-link");
        link.href = url;
        link.download = "android-export.zip";
        document.getElementById("download-container").classList.remove('hidden');
      }
    };
  </script>
</body>
</html>
