<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Exportador Android Figma</title>
  <link rel="icon" href="image/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body class="bg-gray-50 p-6 text-gray-800 font-sans">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Exportar layout para Android</h1>
    <button id="export" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow">
      Exportar
    </button>
  </div>

  <div id="alert" class="mt-2 text-green-600 font-semibold"></div>

  <div id="progress-container" class="hidden mt-4">
    <div class="text-sm mb-1">Exportando: <span id="progress-value">0%</span></div>
    <div class="w-full bg-gray-300 rounded h-3 overflow-hidden">
      <div id="progress-bar" class="h-3 bg-green-500 w-0"></div>
    </div>
  </div>

  <!-- Seção para mostrar as telas selecionadas -->
  <section id="detected-frames" class="mt-6">
    <h2 class="text-lg font-semibold mb-2">Telas Selecionadas</h2>
    <div id="frame-list" class="space-y-4"></div>
  </section>

  <!-- Preview da primeira tela exportada -->
  <section id="preview-container" class="mt-6">
    <h2 class="text-lg font-semibold mb-2">Pré-visualização</h2>
    <img id="preview-image" class="border rounded max-w-full shadow" alt="Prévia do frame" />
  </section>

  <!-- Exibição dos arquivos XML gerados -->
  <section id="xml-container" class="mt-6 max-h-60 overflow-auto bg-white rounded p-4 border shadow">
    <h2 class="text-lg font-semibold mb-2">Arquivos XML Gerados</h2>
    <div id="xml-list" class="space-y-4"></div>
  </section>

  <!-- Link para download do ZIP -->
  <section id="download-container" class="mt-6 hidden">
    <a id="download-link"
       class="inline-block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow"
       href="#" download="android-export.zip">
      Baixar ZIP com todos arquivos
    </a>
  </section>

  <script>
   document.getElementById("export").onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'export-android' } }, '*');

      document.getElementById("alert").textContent = "Exportando...";
      document.getElementById("progress-container").classList.remove("hidden");
      document.getElementById("progress-bar").style.width = "0%";
      document.getElementById("progress-value").textContent = "0%";
      document.getElementById("xml-list").innerHTML = "";
      document.getElementById("frame-list").innerHTML = "";
      document.getElementById("preview-image").src = "";
      document.getElementById("download-container").classList.add("hidden");
    };

    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === "progress") {
        document.getElementById("progress-container").classList.remove("hidden");
        document.getElementById("progress-bar").style.width = msg.percent + "%";
        document.getElementById("progress-value").textContent = msg.percent + "%";
      }

      else if (msg.type === "frames-detected") {
        const frameList = document.getElementById("frame-list");
        frameList.innerHTML = "";

        msg.frames.forEach(frame => {
          const container = document.createElement("div");
          container.className = "border rounded p-4 bg-white shadow";

          const header = document.createElement("div");
          header.className = "flex items-center space-x-4 mb-4";

          const img = document.createElement("img");
          img.src = "data:image/png;base64," + frame.preview;
          img.className = "w-28 h-auto border rounded shadow";

          const info = document.createElement("div");
          info.innerHTML = `<h3 class="font-semibold text-lg">${frame.nome}</h3>`;

          header.appendChild(img);
          header.appendChild(info);
          container.appendChild(header);

          const list = document.createElement("ul");
          list.className = "text-sm list-disc pl-6 space-y-1";

          frame.elementos.forEach(el => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${el.nome}</strong> → <code>${el.tipo}</code>`;
            list.appendChild(li);
          });

          container.appendChild(list);
          frameList.appendChild(container);
        });
      }else if (msg.type === "frames-detected") {
  const frameList = document.getElementById("frame-list");
  frameList.innerHTML = "";

  msg.frames.forEach(frame => {
    const container = document.createElement("div");
    container.className = "border rounded p-4 bg-white shadow";

    const header = document.createElement("div");
    header.className = "flex items-center space-x-4 mb-4";

    const img = document.createElement("img");
    img.src = "data:image/png;base64," + frame.preview;
    img.className = "w-28 h-auto border rounded shadow";

    const info = document.createElement("div");
    info.innerHTML = `<h3 class="font-semibold text-lg">${frame.nome}</h3>`;

    header.appendChild(img);
    header.appendChild(info);
    container.appendChild(header);

    // Lista dos elementos (inputs, buttons, imagens...)
    const list = document.createElement("ul");
    list.className = "text-sm list-disc pl-6 space-y-1";

    frame.elementos.forEach(el => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${el.nome}</strong> → <code>${el.tipo}</code>`;
      list.appendChild(li);
    });
    container.appendChild(list);

    // NOVO: Galeria das imagens inseridas (com nome correto)
    const imagensInseridas = frame.elementos.filter(el => el.tipo === "ImageView" || el.tipo === "ImageButton");

    if (imagensInseridas.length > 0) {
      const galleryTitle = document.createElement("h4");
      galleryTitle.textContent = "Imagens detectadas";
      galleryTitle.className = "mt-4 font-semibold";
      container.appendChild(galleryTitle);

      const gallery = document.createElement("div");
      gallery.className = "flex flex-wrap gap-3 mt-2";

      imagensInseridas.forEach(imgEl => {
        // Aqui você precisa ter a imagem base64 real para mostrar a miniatura.
        // Supondo que no objeto frame venha um campo "imagensBase64" com nomes e base64
        // Por enquanto, vamos usar uma imagem placeholder caso não tenha base64

        // Buscar base64 da imagem pela chave do nome limpo
        const cleanName = imgEl.nome.trim().toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, '');
        const base64img = (frame.imagensBase64 && frame.imagensBase64[cleanName]) || null;

        const imgTag = document.createElement("img");
        imgTag.className = "w-20 h-20 object-cover border rounded shadow";
        if (base64img) {
          imgTag.src = "data:image/png;base64," + base64img;
        } else {
          // Imagem placeholder, pois base64 não foi enviada
          imgTag.alt = "Imagem não disponível";
          imgTag.style.backgroundColor = "#ddd";
        }

        const caption = document.createElement("p");
        caption.className = "text-xs mt-1 text-center";
        caption.textContent = imgEl.nome;

        const wrapper = document.createElement("div");
        wrapper.className = "flex flex-col items-center";
        wrapper.appendChild(imgTag);
        wrapper.appendChild(caption);

        gallery.appendChild(wrapper);
      });

      container.appendChild(gallery);
    }

    frameList.appendChild(container);
  });
}

      
      

      else if (msg.type === "zip-package") {
        document.getElementById("alert").textContent = "Exportação concluída!";
        document.getElementById("progress-container").classList.add("hidden");

        if (msg.preview) {
          document.getElementById("preview-image").src = "data:image/png;base64," + msg.preview;
        }

        const xmlList = document.getElementById("xml-list");
        xmlList.innerHTML = "";

        for (const [fileName, content] of Object.entries(msg.xmls)) {
          const container = document.createElement("div");
          container.classList.add("border", "rounded", "p-2", "bg-gray-100", "shadow");

          const title = document.createElement("h3");
          title.textContent = fileName;
          title.classList.add("font-semibold", "mb-1");
          container.appendChild(title);

          const pre = document.createElement("pre");
          pre.textContent = content;
          pre.classList.add("text-xs", "font-mono", "whitespace-pre-wrap", "max-h-48", "overflow-auto", "mb-2");
          container.appendChild(pre);

          const btn = document.createElement("button");
          btn.textContent = "Baixar XML";
          btn.className = "bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow";
          btn.onclick = () => {
            const blob = new Blob([content], { type: "text/xml" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
          };
          container.appendChild(btn);

          xmlList.appendChild(container);
        }

        // Gerar ZIP para download
        const zip = new JSZip();
        const xmlFolder = zip.folder("xml");
        for (const [fileName, content] of Object.entries(msg.xmls)) {
          xmlFolder.file(fileName, content);
        }
        const drawable = zip.folder("drawable");
        for (const [name, base64] of Object.entries(msg.imagens)) {
          const cleanName = name.toLowerCase();
          const data = base64.split(",")[1];
          drawable.file(`${cleanName}.png`, data, { base64: true });
        }
        const blob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(blob);

        const link = document.getElementById("download-link");
        link.href = url;
        link.download = "android-export.zip";
        document.getElementById("download-container").classList.remove("hidden");
      }
    };
  </script>
</body>
</html>
